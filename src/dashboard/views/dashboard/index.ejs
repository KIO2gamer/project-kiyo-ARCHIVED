<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dashboard - Project Kiyo</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
        />
        <link href="/css/dashboard.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="/dashboard">
                    <i class="fas fa-robot me-2"></i>Project Kiyo
                </a>

                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="/dashboard">
                                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/servers">
                                <i class="fas fa-server me-1"></i>Servers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/commands">
                                <i class="fas fa-terminal me-1"></i>Commands
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/monitoring">
                                <i class="fas fa-chart-line me-1"></i>Monitoring
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/users">
                                <i class="fas fa-users me-1"></i>Users
                            </a>
                        </li>
                    </ul>

                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a
                                class="nav-link dropdown-toggle"
                                href="#"
                                role="button"
                                data-bs-toggle="dropdown"
                            >
                                <img
                                    src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png"
                                    alt="Avatar"
                                    class="rounded-circle me-1"
                                    width="24"
                                    height="24"
                                />
                                <%= user.username %>
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="/dashboard/settings">
                                        <i class="fas fa-cog me-1"></i>Settings
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a class="dropdown-item" href="/auth/logout">
                                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container-fluid mt-4">
            <div class="row">
                <!-- Welcome Card -->
                <div class="col-12 mb-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h4 class="card-title mb-1">
                                        Welcome back, <%= user.username %>!
                                    </h4>
                                    <p class="card-text mb-0">
                                        Here's what's happening with your bot today.
                                    </p>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-robot fa-3x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Bot Stats -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div
                                        class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                                    >
                                        Active Servers
                                    </div>
                                    <div
                                        class="h5 mb-0 font-weight-bold text-gray-800"
                                        id="guild-count"
                                    >
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-server fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div
                                        class="text-xs font-weight-bold text-success text-uppercase mb-1"
                                    >
                                        Total Users
                                    </div>
                                    <div
                                        class="h5 mb-0 font-weight-bold text-gray-800"
                                        id="user-count"
                                    >
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div
                                        class="text-xs font-weight-bold text-info text-uppercase mb-1"
                                    >
                                        Bot Ping
                                    </div>
                                    <div
                                        class="h5 mb-0 font-weight-bold text-gray-800"
                                        id="bot-ping"
                                    >
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-wifi fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div
                                        class="text-xs font-weight-bold text-warning text-uppercase mb-1"
                                    >
                                        Uptime
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="uptime">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clock fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Activity Chart -->
                <div class="col-xl-8 col-lg-7">
                    <div class="card shadow mb-4">
                        <div
                            class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                        >
                            <h6 class="m-0 font-weight-bold text-primary">Bot Activity Overview</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-area">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-xl-4 col-lg-5">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/dashboard/servers" class="btn btn-primary">
                                    <i class="fas fa-server me-2"></i>Manage Servers
                                </a>
                                <a href="/dashboard/commands" class="btn btn-success">
                                    <i class="fas fa-terminal me-2"></i>Configure Commands
                                </a>
                                <a href="/dashboard/monitoring" class="btn btn-info">
                                    <i class="fas fa-chart-line me-2"></i>View Analytics
                                </a>
                                <a href="/dashboard/settings" class="btn btn-warning">
                                    <i class="fas fa-cog me-2"></i>Bot Settings
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Memory Usage -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">System Resources</h6>
                        </div>
                        <div class="card-body">
                            <h4 class="small font-weight-bold">
                                Memory Usage <span class="float-right" id="memory-percent">0%</span>
                            </h4>
                            <div class="progress mb-4">
                                <div
                                    class="progress-bar bg-info"
                                    role="progressbar"
                                    id="memory-bar"
                                    style="width: 0%"
                                ></div>
                            </div>
                            <div class="text-center">
                                <small class="text-muted" id="memory-details">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Load dashboard data
                async function loadDashboardData() {
                    try {
                        const response = await fetch("/api/stats");
                        const data = await response.json();

                        // Update stats
                        document.getElementById("guild-count").textContent = data.guilds;
                        document.getElementById("user-count").textContent =
                            data.users.toLocaleString();
                        document.getElementById("bot-ping").textContent = data.ping + "ms";

                        // Format uptime
                        const uptime = data.uptime;
                        const days = Math.floor(uptime / 86400);
                        const hours = Math.floor((uptime % 86400) / 3600);
                        const minutes = Math.floor((uptime % 3600) / 60);
                        document.getElementById("uptime").textContent =
                            `${days}d ${hours}h ${minutes}m`;

                        // Update memory usage
                        const memUsage = data.memoryUsage;
                        const usedMB = Math.round(memUsage.heapUsed / 1024 / 1024);
                        const totalMB = Math.round(memUsage.rss / 1024 / 1024);
                        const percentage = Math.round((memUsage.heapUsed / memUsage.rss) * 100);

                        document.getElementById("memory-percent").textContent = percentage + "%";
                        document.getElementById("memory-bar").style.width = percentage + "%";
                        document.getElementById("memory-details").textContent =
                            `${usedMB}MB / ${totalMB}MB`;
                    } catch (error) {
                        console.error("Error loading dashboard data:", error);
                        dashboard.showAlert("danger", "Failed to load dashboard data");
                    }
                }

                // Initialize activity chart with real data
                async function initActivityChart() {
                    try {
                        const response = await fetch("/api/stats/history?hours=24");
                        const result = await response.json();

                        const ctx = document.getElementById("activityChart").getContext("2d");

                        if (result.success && result.stats.length > 0) {
                            const labels = result.stats.map((stat) => {
                                const date = new Date(stat.timestamp);
                                return date.getHours() + ":00";
                            });

                            const commandData = result.stats.map(
                                (stat) => stat.commandsExecuted || 0,
                            );
                            const memoryData = result.stats.map((stat) =>
                                Math.round((stat.memoryUsage?.heapUsed || 0) / 1024 / 1024),
                            );

                            new Chart(ctx, {
                                type: "line",
                                data: {
                                    labels: labels,
                                    datasets: [
                                        {
                                            label: "Commands Executed",
                                            data: commandData,
                                            borderColor: "rgb(75, 192, 192)",
                                            backgroundColor: "rgba(75, 192, 192, 0.1)",
                                            tension: 0.1,
                                            yAxisID: "y",
                                        },
                                        {
                                            label: "Memory Usage (MB)",
                                            data: memoryData,
                                            borderColor: "rgb(255, 99, 132)",
                                            backgroundColor: "rgba(255, 99, 132, 0.1)",
                                            tension: 0.1,
                                            yAxisID: "y1",
                                        },
                                    ],
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            type: "linear",
                                            display: true,
                                            position: "left",
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: "Commands",
                                            },
                                        },
                                        y1: {
                                            type: "linear",
                                            display: true,
                                            position: "right",
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: "Memory (MB)",
                                            },
                                            grid: {
                                                drawOnChartArea: false,
                                            },
                                        },
                                    },
                                },
                            });
                        } else {
                            // Fallback to sample data if no real data available
                            const labels = [];
                            const data = [];
                            const now = new Date();

                            for (let i = 23; i >= 0; i--) {
                                const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                                labels.push(time.getHours() + ":00");
                                data.push(0); // No data yet
                            }

                            new Chart(ctx, {
                                type: "line",
                                data: {
                                    labels: labels,
                                    datasets: [
                                        {
                                            label: "Commands Executed",
                                            data: data,
                                            borderColor: "rgb(75, 192, 192)",
                                            backgroundColor: "rgba(75, 192, 192, 0.1)",
                                            tension: 0.1,
                                        },
                                    ],
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                        },
                                    },
                                },
                            });
                        }
                    } catch (error) {
                        console.error("Error loading activity chart:", error);
                        dashboard.showAlert("warning", "Failed to load activity chart data");
                    }
                }

                // Load data on page load
                document.addEventListener("DOMContentLoaded", function () {
                    loadDashboardData();
                    initActivityChart();

                    // Refresh data every 30 seconds
                    setInterval(loadDashboardData, 30000);
                });
            </script>

            <style>
                .border-left-primary {
                    border-left: 0.25rem solid #4e73df !important;
                }
                .border-left-success {
                    border-left: 0.25rem solid #1cc88a !important;
                }
                .border-left-info {
                    border-left: 0.25rem solid #36b9cc !important;
                }
                .border-left-warning {
                    border-left: 0.25rem solid #f6c23e !important;
                }
                .chart-area {
                    position: relative;
                    height: 300px;
                }
            </style>
        </main>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="/js/dashboard.js"></script>
    </body>
</html>
