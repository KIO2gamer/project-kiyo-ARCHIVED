<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Kiyo Bot - Dashboard</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
		/>
		<link rel="stylesheet" href="/assets/css/dashboard.css" />
		<link
			rel="shortcut icon"
			href="/assets/img/favicon.ico"
			type="image/x-icon"
		/>
	</head>
	<body>
		<div class="dashboard-container">
			<!-- Sidebar -->
			<aside class="sidebar">
				<div class="sidebar-header">
					<img
						src="/assets/img/logo.png"
						alt="Kiyo"
						class="sidebar-logo"
					/>
					<h1>Kiyo Dashboard</h1>
				</div>
				<nav class="sidebar-nav">
					<ul>
						<li class="active">
							<a href="/dashboard/home"
								><i class="bi bi-house-door"></i> Home</a
							>
						</li>
						<li>
							<a href="/dashboard/servers"
								><i class="bi bi-server"></i> Servers</a
							>
						</li>
						<li>
							<a href="/dashboard/commands"
								><i class="bi bi-command"></i> Commands</a
							>
						</li>
						<li>
							<a href="/dashboard/settings"
								><i class="bi bi-gear"></i> Settings</a
							>
						</li>
					</ul>
				</nav>
				<div class="sidebar-footer">
					<a href="/" class="btn btn-outline-light btn-sm">
						<i class="bi bi-box-arrow-left"></i> Back to Site
					</a>
				</div>
			</aside>

			<!-- Main Content -->
			<main class="main-content">
				<header class="content-header">
					<div
						class="d-flex justify-content-between align-items-center"
					>
						<h2><i class="bi bi-house-door"></i> Dashboard</h2>
						<div class="user-profile" id="user-profile">
							<div
								class="spinner-border spinner-border-sm text-light"
								role="status"
							>
								<span class="visually-hidden">Loading...</span>
							</div>
						</div>
					</div>
				</header>

				<div class="content-body">
					<!-- Stats Cards -->
					<div class="row g-4 mb-4">
						<div class="col-md-3">
							<div class="stat-card">
								<div class="stat-card-icon bg-primary">
									<i class="bi bi-server"></i>
								</div>
								<div class="stat-card-content">
									<h3 id="server-count">-</h3>
									<p>Servers</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="stat-card">
								<div class="stat-card-icon bg-success">
									<i class="bi bi-people"></i>
								</div>
								<div class="stat-card-content">
									<h3 id="user-count">-</h3>
									<p>Users</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="stat-card">
								<div class="stat-card-icon bg-info">
									<i class="bi bi-chat-left-text"></i>
								</div>
								<div class="stat-card-content">
									<h3 id="channel-count">-</h3>
									<p>Channels</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="stat-card">
								<div class="stat-card-icon bg-warning">
									<i class="bi bi-command"></i>
								</div>
								<div class="stat-card-content">
									<h3 id="command-count">-</h3>
									<p>Commands</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Server List -->
					<div class="card mb-4">
						<div
							class="card-header d-flex justify-content-between align-items-center"
						>
							<h5>
								<i class="bi bi-server me-2"></i>Your Servers
							</h5>
							<a
								href="/dashboard/servers"
								class="btn btn-sm btn-primary"
								>View All</a
							>
						</div>
						<div class="card-body">
							<div id="managed-servers" class="server-grid">
								<div class="text-center py-4">
									<div
										class="spinner-border text-primary"
										role="status"
									>
										<span class="visually-hidden"
											>Loading...</span
										>
									</div>
									<p class="mt-2">Loading your servers...</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Recent Activity -->
					<div class="card">
						<div class="card-header">
							<h5>
								<i class="bi bi-activity me-2"></i>Recent
								Activity
							</h5>
						</div>
						<div class="card-body">
							<div id="recent-activity">
								<ul class="activity-list" id="activity-list">
									<!-- Activity items loaded via JS -->
								</ul>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			// Fetch user profile
			async function fetchUserProfile() {
				try {
					const response = await fetch(
						'/.netlify/functions/dashboardApi/profile',
					);
					if (!response.ok) {
						if (response.status === 401) {
							window.location.href =
								'/.netlify/functions/dashboardAuth';
							return;
						}
						throw new Error('Failed to fetch profile');
					}

					const data = await response.json();

					// Update profile UI
					const userProfileEl =
						document.getElementById('user-profile');
					userProfileEl.innerHTML = `
          <div class="d-flex align-items-center">
            <img src="https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png?size=64" 
              alt="${data.username}" class="avatar me-2">
            <span class="username">${data.username}</span>
            <a href="/logout" class="btn btn-sm btn-outline-light ms-3">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </div>
        `;
				} catch (error) {
					console.error('Error fetching profile:', error);
					document.getElementById('user-profile').innerHTML =
						'<div class="alert alert-danger p-2 m-0">Failed to load profile</div>';
				}
			}

			// Fetch servers
			async function fetchServers() {
				try {
					const response = await fetch(
						'/.netlify/functions/dashboardApi/guilds',
					);
					if (!response.ok) {
						throw new Error('Failed to fetch servers');
					}

					const data = await response.json();
					document.getElementById('server-count').textContent =
						data.guilds.length;

					// Update servers grid
					const serversContainer =
						document.getElementById('managed-servers');
					if (data.guilds.length === 0) {
						serversContainer.innerHTML = `
            <div class="alert alert-info m-0">
              No servers found. Add Kiyo to a server where you have management permissions.
              <a href="${data.inviteUrl}" class="alert-link">Add to a server</a>
            </div>`;
						return;
					}

					serversContainer.innerHTML = '';

					// Display up to 6 servers with manage permissions
					const displayGuilds = data.guilds.slice(0, 6);

					displayGuilds.forEach((guild) => {
						const serverCard = document.createElement('div');
						serverCard.className = 'server-card';

						const serverIcon = guild.icon
							? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png?size=128`
							: '/assets/img/default-server.png';

						serverCard.innerHTML = `
            <div class="server-icon">
              <img src="${serverIcon}" alt="${guild.name}" loading="lazy">
            </div>
            <div class="server-info">
              <h4>${guild.name}</h4>
              <a href="/dashboard/servers?id=${guild.id}" class="btn btn-sm btn-primary">Manage</a>
            </div>
          `;

						serversContainer.appendChild(serverCard);
					});
				} catch (error) {
					console.error('Error fetching servers:', error);
					document.getElementById('managed-servers').innerHTML =
						'<div class="alert alert-danger">Failed to load servers. Please try again later.</div>';
				}
			}

			// Fetch statistics
			async function fetchStatistics() {
				try {
					const response = await fetch(
						'/.netlify/functions/dashboardApi/stats',
					);
					if (!response.ok) {
						throw new Error('Failed to fetch statistics');
					}
					const data = await response.json();

					document.getElementById('user-count').textContent =
						data.users.toLocaleString();
					document.getElementById('channel-count').textContent =
						data.channels.toLocaleString();
					document.getElementById('command-count').textContent =
						data.commands.toLocaleString();
				} catch (error) {
					console.error('Error fetching statistics:', error);
				}
			}

			// Fetch recent activity
			async function fetchActivity() {
				try {
					const response = await fetch(
						'/.netlify/functions/dashboardApi/activity',
					);
					if (!response.ok) {
						throw new Error('Failed to fetch activity');
					}

					const data = await response.json();
					const activityList =
						document.getElementById('activity-list');

					if (data.activities.length === 0) {
						activityList.innerHTML =
							'<li class="no-activity">No recent activity</li>';
						return;
					}

					activityList.innerHTML = '';
					data.activities.forEach((activity) => {
						const li = document.createElement('li');
						li.className = 'activity-item';

						let icon = '';
						switch (activity.type) {
							case 'join':
								icon = 'bi-person-plus';
								break;
							case 'leave':
								icon = 'bi-person-dash';
								break;
							case 'command':
								icon = 'bi-terminal';
								break;
							case 'config':
								icon = 'bi-gear';
								break;
							default:
								icon = 'bi-info-circle';
						}

						const time = new Date(
							activity.timestamp,
						).toLocaleString();

						li.innerHTML = `
            <div class="activity-icon"><i class="bi ${icon}"></i></div>
            <div class="activity-content">
              <p>${activity.message}</p>
              <small>${time}</small>
            </div>
          `;

						activityList.appendChild(li);
					});
				} catch (error) {
					console.error('Error fetching activity:', error);
					document.getElementById('activity-list').innerHTML =
						'<li class="no-activity error">Failed to load activity</li>';
				}
			}

			// Initialize
			document.addEventListener('DOMContentLoaded', () => {
				fetchUserProfile();
				fetchServers();
				fetchStatistics();
				fetchActivity();
			});
		</script>
	</body>
</html>
