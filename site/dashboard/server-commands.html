<!-- New file: site/dashboard/server-commands.html -->
<!doctype html>
<html lang="en">
	<head>
		<!-- Include standard header content -->
		<title>Server Commands - Kiyo Dashboard</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
		/>
		<link rel="stylesheet" href="/assets/css/dashboard.css" />
		<script src="/assets/js/theme-system.js"></script>
	</head>
	<body>
		<div class="dashboard-container">
			<!-- Sidebar -->
			<aside class="sidebar">
				<div class="sidebar-header">
					<img
						src="/assets/img/logo.png"
						alt="Kiyo"
						class="sidebar-logo"
					/>
					<h1>Kiyo Dashboard</h1>
				</div>
				<nav class="sidebar-nav">
					<ul>
						<li class="nav-item" id="nav-home">
							<a href="/dashboard/home"
								><i class="bi bi-house-door"></i> Home</a
							>
						</li>
						<li class="nav-item" id="nav-servers">
							<a href="/dashboard/servers"
								><i class="bi bi-server"></i> Servers</a
							>
						</li>
						<li class="nav-item" id="nav-commands">
							<a href="/dashboard/commands"
								><i class="bi bi-command"></i> Commands</a
							>
						</li>
						<li class="nav-item" id="nav-settings">
							<a href="/dashboard/settings"
								><i class="bi bi-gear"></i> Settings</a
							>
						</li>
					</ul>
				</nav>
				<div class="sidebar-footer">
					<a href="/" class="btn btn-outline-light btn-sm">
						<i class="bi bi-box-arrow-left"></i> Back to Site
					</a>
				</div>
			</aside>

			<main class="main-content">
				<header class="content-header">
					<div
						class="d-flex justify-content-between align-items-center"
					>
						<h2><i class="bi bi-command"></i> Server Commands</h2>
						<div id="user-profile">
							<!-- User profile loaded via JS -->
						</div>
					</div>
				</header>

				<div class="content-body">
					<div class="alert alert-info">
						<i class="bi bi-info-circle me-2"></i>
						Configure which commands are enabled for
						<strong id="server-name">this server</strong>
					</div>

					<!-- Command Categories -->
					<div class="card mb-4">
						<div class="card-header">
							<ul
								class="nav nav-tabs card-header-tabs"
								id="command-categories"
							>
								<li class="nav-item">
									<a class="nav-link active" href="#all"
										>All Commands</a
									>
								</li>
								<!-- Other categories added dynamically -->
							</ul>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table">
									<thead>
										<tr>
											<th>Command</th>
											<th>Description</th>
											<th>Category</th>
											<th>Status</th>
										</tr>
									</thead>
									<tbody id="commands-list">
										<!-- Commands loaded here -->
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>

		<!-- Scripts -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="/assets/js/dashboard-common.js"></script>
		<script src="/assets/js/server-commands.js"></script>
		<script>
			/**
			 * server-commands.js - Handles server-specific command management
			 * For use with server-commands.html page
			 */

			document.addEventListener('DOMContentLoaded', async () => {
				try {
					// Check if API Service is available
					if (
						!window.ApiService ||
						!window.ApiService.fetchWithAuth
					) {
						throw new Error('API Service not available');
					}

					// Get server ID from URL query params
					const urlParams = new URLSearchParams(
						window.location.search,
					);
					const serverId = urlParams.get('id');

					if (!serverId) {
						showError(
							'No server ID provided. Please select a server first.',
						);
						return;
					}

					// Rest of initialization...
				} catch (error) {
					console.error('Error initializing page:', error);
					showError(
						'Failed to initialize page. Please try again later.',
					);
				}
			});

			// Server and commands data containers
			let currentServer = null;
			let allCommands = [];
			let categories = new Set();

			// Initialize when DOM is loaded
			document.addEventListener('DOMContentLoaded', async () => {
				try {
					// Initialize theme if ThemeSystem exists
					if (window.ThemeSystem) {
						try {
							// Only initialize if not already initialized
							if (
								!document.body.classList.contains(
									'theme-light',
								) &&
								!document.body.classList.contains('theme-dark')
							) {
								window.ThemeSystem.initialize();
							}
						} catch (error) {
							console.warn(
								'Error initializing theme system:',
								error,
							);
						}
					}

					// Continue with other initializations...
					initializeServerCommands();

					// Get server ID from URL query params
					const urlParams = new URLSearchParams(
						window.location.search,
					);
					const serverId = urlParams.get('id');

					if (!serverId) {
						showError(
							'No server ID provided. Please select a server first.',
						);
						return;
					}

					// Load user profile
					await loadUserProfile();

					// Load server data
					await loadServerData(serverId);

					// Load commands
					await loadServerCommands(serverId);

					// Initialize event listeners
					initializeEventListeners();
				} catch (error) {
					console.error(
						'Error initializing server commands page:',
						error,
					);
					showError(
						'Failed to load server commands. Please try again later.',
					);
				}
			});

			/**
			 * Load server basic data
			 * @param {string} serverId Server ID
			 */
			async function loadServerData(serverId) {
				try {
					const response = await window.ApiService.fetchWithAuth(
						`${API_BASE}/guilds/${serverId}`,
					);

					if (response.status === 401) {
						// Redirect to login if unauthorized
						window.location.href =
							'/.netlify/functions/dashboardAuth';
						return;
					}

					if (!response.ok) {
						throw new Error(
							`Failed to load server data: ${response.status}`,
						);
					}

					const server = await response.json();
					currentServer = server;

					// Update UI with server information
					document.getElementById('server-name').textContent =
						server.name;
					document.title = `${server.name} - Command Management | Kiyo Dashboard`;
				} catch (error) {
					console.error('Error loading server data:', error);
					showToast('error', 'Failed to load server information');
				}
			}

			/**
			 * Load server commands with status
			 * @param {string} serverId Server ID
			 */
			async function loadServerCommands(serverId) {
				try {
					const response = await window.ApiService.fetchWithAuth(
						`${API_BASE}/guilds/${serverId}/commands`,
					);
					if (!response.ok)
						throw new Error(
							`Failed to load commands: ${response.status}`,
						);

					const data = await response.json();
					allCommands = data.commands;

					// Extract categories
					allCommands.forEach((cmd) => {
						if (cmd.category) categories.add(cmd.category);
					});

					// Populate category tabs
					populateCategoryTabs();

					// Display all commands by default
					displayCommandsByCategory('all');
				} catch (error) {
					console.error('Error loading server commands:', error);
					showToast('error', 'Failed to load server commands');
				}
			}

			/**
			 * Populate category tabs
			 */
			function populateCategoryTabs() {
				const tabContainer =
					document.getElementById('command-categories');

				// Add category tabs
				categories.forEach((category) => {
					const li = document.createElement('li');
					li.className = 'nav-item';
					li.innerHTML = `<a class="nav-link" href="#${category.toLowerCase()}" 
								data-category="${category.toLowerCase()}">${category}</a>`;
					tabContainer.appendChild(li);
				});

				// Add event listeners to tabs
				tabContainer.querySelectorAll('a.nav-link').forEach((tab) => {
					tab.addEventListener('click', function (e) {
						e.preventDefault();

						// Remove active class from all tabs
						tabContainer
							.querySelectorAll('a.nav-link')
							.forEach((t) => {
								t.classList.remove('active');
							});

						// Add active class to clicked tab
						this.classList.add('active');

						// Display commands for selected category
						const category = this.getAttribute('data-category');
						displayCommandsByCategory(category);
					});
				});
			}

			/**
			 * Display commands by category
			 * @param {string} category Category to display (or 'all' for all)
			 */
			function displayCommandsByCategory(category) {
				const commandsList = document.getElementById('commands-list');
				commandsList.innerHTML = '';

				const filteredCommands =
					category === 'all'
						? allCommands
						: allCommands.filter(
								(cmd) =>
									cmd.category.toLowerCase() === category,
							);

				if (filteredCommands.length === 0) {
					commandsList.innerHTML = `
						<tr>
							<td colspan="4" class="text-center py-4">
								<div class="alert alert-info mb-0">
									No commands found in this category.
								</div>
							</td>
						</tr>
					`;
					return;
				}

				filteredCommands.forEach((command) => {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td><code>${command.type === 'slash' ? '/' : '!'}${command.name}</code></td>
						<td>${command.description || 'No description available'}</td>
						<td><span class="badge bg-secondary">${command.category}</span></td>
						<td>
							<div class="form-check form-switch">
								<input class="form-check-input command-toggle" type="checkbox" 
										id="toggle-${command.id}" 
										data-command-id="${command.id}"
										${command.enabled ? 'checked' : ''}>
								<label class="form-check-label" for="toggle-${command.id}">
									${command.enabled ? 'Enabled' : 'Disabled'}
								</label>
							</div>
						</td>
					`;
					commandsList.appendChild(row);
				});

				// Update toggle switch event listeners
				attachToggleListeners();
			}

			/**
			 * Attach event listeners to command toggle switches
			 */
			function attachToggleListeners() {
				document
					.querySelectorAll('.command-toggle')
					.forEach((toggle) => {
						toggle.addEventListener('change', async function () {
							const commandId =
								this.getAttribute('data-command-id');
							const enabled = this.checked;
							const label = this.nextElementSibling;

							try {
								await window.ApiService.updateServerCommand(
									currentServer.id,
									commandId,
									enabled,
								);
								label.textContent = enabled
									? 'Enabled'
									: 'Disabled';
								showToast(
									'success',
									`Command ${enabled ? 'enabled' : 'disabled'} successfully`,
								);
							} catch (error) {
								console.error(
									'Error updating command status:',
									error,
								);
								// Revert the toggle
								this.checked = !enabled;
								label.textContent = !enabled
									? 'Enabled'
									: 'Disabled';
								showToast(
									'error',
									'Failed to update command status',
								);
							}
						});
					});
			}

			/**
			 * Initialize event listeners
			 */
			function initializeEventListeners() {
				// Add bulk actions if needed
				const bulkEnableBtn = document.getElementById('bulk-enable');
				const bulkDisableBtn = document.getElementById('bulk-disable');

				if (bulkEnableBtn) {
					bulkEnableBtn.addEventListener('click', () =>
						bulkUpdateCommands(true),
					);
				}

				if (bulkDisableBtn) {
					bulkDisableBtn.addEventListener('click', () =>
						bulkUpdateCommands(false),
					);
				}
			}

			/**
			 * Bulk update commands
			 * @param {boolean} enabled Whether to enable or disable selected commands
			 */
			function bulkUpdateCommands(enabled) {
				const selectedCommands = Array.from(
					document.querySelectorAll('.command-checkbox:checked'),
				).map((cb) => cb.getAttribute('data-command-id'));

				if (selectedCommands.length === 0) {
					showToast('warning', 'No commands selected');
					return;
				}

				Promise.all(
					selectedCommands.map((id) =>
						window.ApiService.updateServerCommand(
							currentServer.id,
							id,
							enabled,
						),
					),
				)
					.then(() => {
						showToast(
							'success',
							`${selectedCommands.length} commands ${enabled ? 'enabled' : 'disabled'} successfully`,
						);
						loadServerCommands(currentServer.id); // Refresh commands
					})
					.catch((error) => {
						console.error('Error updating commands:', error);
						showToast('error', 'Failed to update some commands');
					});
			}

			/**
			 * Show error message in main content area
			 * @param {string} message Error message
			 */
			function showError(message) {
				const contentBody = document.querySelector('.content-body');
				contentBody.innerHTML = `
					<div class="alert alert-danger">
						<i class="bi bi-exclamation-triangle me-2"></i> ${message}
					</div>
					<div class="text-center mt-3">
						<a href="/dashboard/servers" class="btn btn-primary">
							<i class="bi bi-arrow-left me-2"></i> Back to Servers
						</a>
					</div>
				`;
			}
		</script>
	</body>
</html>
